<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React!</title>
    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
    <style>
.timer {
  font: bold 300% monospace;
  display: inline-block;
}
.timer_display {
  width: 4em;
  font: bold 300% monospace;
  display: inline-block;
}
.timer_console {
  display: inline-block;
}
.timer button {
  width: 2em;
  height: 2em;
  vertical-align: super;
}
.timer_list_item {
  display: inline-block;
  width: 3em;
  text-align: right;
}
    </style>
  </head>
  <body>
    <div id="example"></div>

    <script type="text/babel">
      class Time {
        
        constructor(str) {
          var min, sec
          [this.message, min, sec] = str.split(':').map( (s) => Number(s) )
          min = min ? min : 0
          sec = sec ? sec : 0
          this.secs = min * 60 + sec
        }

        get min() {
          return Math.floor(this.secs / 60)
        }

        get sec() {
          return this.secs % 60
        }

        tick() {
            -- this.secs
        }

        isEnd() {
          return this.secs <= 0
        }

        toString() {
          return this.message + this.min + ":" + (this.sec && this.sec >= 10 ? this.sec : '0' + this.sec)
        }
      }
      var intervalId
      var TimerBox = React.createClass({
        getInitialState() {
          return {
            times: []
          };
        },
        render() {
          return (
            <div>
              <div className="timer_display">
                <button onClick={this.clickRemove} value="0" >×</button>
                {this.state.times.length ? this.state.times[0].toString() : ''}
              </div>
              <div className="timer_console">
                <button onClick={this.start} >▶</button><br />
                <button onClick={this.stop} >■</button><br />
              </div>
              <ul>
                {
                  this.state.times.slice(1).map((time, i) =>
                    <li key={i}>
                      <button onClick={this.clickRemove} value={i+1}>×</button>
                      <span className="timer_list_item">{time.toString()}</span>
                    </li>
                  )
                }
                <li>
                  <input type="text" ref="newTime" pattern="\d+:\d{2}"
                   onKeyDown={this.keyDown} />
                </li>
              </ul>
            </div>
          )
        },
        keyDown(event) {
          if (event.keyCode == 13) { // Enter
            this.add(event.target.value)
          }
        },
        clickRemove(event) {
          this.remove(Number(event.target.value))
        },
        add(str) {
          this.setState({
            times: this.state.times.concat(new Time(str))
          })
        },
        remove(index) {
          var times = this.state.times
          times = times.slice(0, index).concat(times.slice(1+index))

          if (times.length == 0) {
            this.stop()
          }

          this.setState({
            times: times
          })
        },
        start() {
          if (intervalId) return;

          var timer = this

          intervalId = setInterval(
            ()=>{
              var times = timer.state.times

              times[0].tick()
              if (times[0].isEnd()) {
                timer.remove(0)
              } else {
                timer.setState({
                  times: times
                })
              }
              
            },
            1000
          )
        },
        stop() {
          if (! intervalId) return;

          clearInterval(intervalId);
          intervalId = false
        }
      });

      var TimerApp = React.createClass({
        render: function() {
          return <div className="timer">
            <TimerBox />
          </div>
        }
      })

      ReactDOM.render(
        <TimerApp />,
        document.getElementById('example')
      );
    </script>
  </body>
</html>
